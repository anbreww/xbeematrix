#ifndef F_CPU
#define F_CPU 8000000L
#endif
#include <avr/io.h>
#include <util/delay.h>
#include <stdio.h>
#include <stdlib.h>

// TODO : remove this temporary workaround
//#define CONFIG_H
#include "quadm.h"


#define SCROLLRATE      2

unsigned char AArray[] ={
		0x01,0x80,0x03,0xC0,0x07,0xE0,0x0F,0xF0,
		0x1F,0xF8,0x3F,0xFC,0x7F,0xFE,0xFF,0xFF,
		0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
		0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
		0xFF,0xFF,0x7F,0xFE,0x3F,0xFC,0x1F,0xF8,
		0x0F,0xF0,0x07,0xE0,0x03,0xC0,0x01,0x80,
		};   
#define ARRAY_LENGTH 127
unsigned char Fireday[] ={ 		// "Fireday UNO"
		0xF8,0x00,0xA0,0x7C,0x80,0x7E,0x00,0x06,	
		0xF8,0x06,0x00,0x7E,0xF8,0x7C,0xA0,0x00,

		0x58,0x00,0x00,0x7E,0xF8,0x7E,0xA8,0x38,
		0x00,0x1C,0xF8,0x7E,0x88,0x7E,0x70,0x00,

		0x00,0x00,0x78,0x3C,0xA0,0x7E,0x78,0x66,
		0x00,0x66,0xC0,0x7E,0x38,0x3C,0xC0,0x00,

		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,

//		};
//unsigned char Samedi[] = {	// "Samedi 29 NOV"
		0xE8,0x26,0xA8,0x4a,0xB8,0x52,0x00,0x22,
		0x78,0x00,0xa0,0x72,0xa0,0x54,0x78,0x78,

		0x00,0x00,0xf8,0x7e,0x40,0x30,0x20,0x18,
		0x40,0x7e,0xF8,0x00,0x00,0x3c,0xf8,0x42,

		0xa8,0x42,0x88,0x3c,0x00,0x00,0xf8,0x78,
		0x88,0x04,0x70,0x02,0x00,0x04,0xf8,0x78,

		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

unsigned char bigbuffer[QM_BUFFER_SIZE];


int main (void)
{
	uint8_t scroll = 0;

	_delay_ms(400);
	PORTA = 0x00;
	DDRA = 0b11111111;
	PORTB = 0;
	DDRB = 0xFF;

	DDRD = 0xFF;
	//TCCR2 = 0b00010001;
	//OCR2 = 0x00;
	//
	unsigned char rxbuff[30];
	unsigned char txbuff[30];
	
	//srand(42);


	init_matrix();

#define L_OF 8
#define B_END QM_BUFFER_SIZE
#define null 0

	uint8_t x = 0;
	for(x = 0; x < QM_BUFFER_SIZE-L_OF; x++)
	{
		if (x % 2)
			bigbuffer[x+L_OF] = (Fireday[x % (ARRAY_LENGTH+1)]);
		else
			bigbuffer[x+L_OF] = (Fireday[x % (ARRAY_LENGTH+1)])>>2;
	}
	bigbuffer[B_END-2] = 0xff;
	bigbuffer[B_END-1] = 0xff;
	bigbuffer[0] = 0x00;
	bigbuffer[1] = 0x00;

	uart_init(null, rxbuff, null, txbuff);
	uart_transmit_string_block("Hello World\r\n");

	sprintf(txbuff, "I am a sending buffer\r\n");
	//uart_start_transmission(10);

	

	while(1)
	{

		_delay_ms(8);

		write_array_to_board(bigbuffer,scroll,QM_BUFFER_SIZE-1);
		//write_array_to_board(Samedi,scroll);



		if (scroll == QM_BUFFER_SIZE/2);
	//	_delay_ms(2000);	// pause in the middle for second panel

		if (scroll > QM_BUFFER_SIZE || scroll == 0) 	
		{	
			scroll = 0;			// start again at the end of the array
			//_delay_ms(5000);	// and pause to show the first panel
		}
		
		_delay_ms(5); 	// scroll interval 
		scroll += SCROLLRATE;	// 1 vertical line = 2 bytes


	}
}



